{% load static %}

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="{% static 'etudiants/css/faire_test.css' %}">
  <title>ISFAD | Test </title>
  <style>
    /* Conteneur des toasts */
    #toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
    }

    /* Style commun */
    .toast {
      color: white;
      padding: 12px 20px;
      margin-bottom: 10px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
      font-weight: bold;
      animation: fadeIn 0.5s, fadeOut 0.5s 2.5s;
    }

    /* Rouge = erreur */
    .toast-error {
      background: #d32f2f;
    }

    /* Vert = succ√®s */
    .toast-success {
      background: #2e7d32;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateX(100%); }
      to { opacity: 1; transform: translateX(0); }
    }

    @keyframes fadeOut {
      from { opacity: 1; transform: translateX(0); }
      to { opacity: 0; transform: translateX(100%); }
    }
  </style>
</head>
<body>

<div class="container">
  <a href="{% url 'evaluation' %}" id="az">Retour</a>
  <h1>Quiz Test</h1>

  <!-- Conteneur pour les toasts -->
  <div id="toast-container"></div>

  <div id="quiz" aria-live="polite" aria-atomic="true" aria-relevant="additions"></div>

  <div id="quiz-controls">
    <button id="prev-btn" class="btn-nav" disabled>Pr√©c√©dent</button>
    <button id="next-btn" class="btn-nav">Suivant</button>
  </div>
</div>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  const testId = urlParams.get('id') || '1';

  let questions = [];
  let currentQuestionIndex = 0;
  let selectedAnswers = [];

  const quizEl = document.getElementById("quiz");
  const prevBtn = document.getElementById("prev-btn");
  const nextBtn = document.getElementById("next-btn");

  // Fonction Toast
  function showToast(message, type = "error") {
    const container = document.getElementById("toast-container");
    const toast = document.createElement("div");

    toast.className = "toast " + (type === "success" ? "toast-success" : "toast-error");
    toast.textContent = message;

    container.appendChild(toast);

    // Supprimer le toast apr√®s 3s
    setTimeout(() => {
      toast.remove();
    }, 3000);
  }

  function displayQuestion(index) {
    const q = questions[index];
    if (!q) return;

    let answersHTML = "";
    q.answers.forEach((ans, i) => {
      const checked = selectedAnswers[index] === i ? "checked" : "";
      answersHTML += `
        <label>
          <input type="radio" name="answer" value="${i}" ${checked} />
          ${ans}
        </label>
      `;
    });

    quizEl.innerHTML = `
      <div class="question">${index + 1}. ${q.question}</div>
      <div class="answers">${answersHTML}</div>
    `;

    prevBtn.disabled = index === 0;
    nextBtn.textContent = index === questions.length - 1 ? "Valider" : "Suivant";
  }

  function afficherResultat() {
    let score = 0;
    let total = 0;

    questions.forEach((q, i) => {
      total += q.points || 1;
      if (selectedAnswers[i] === q.correct) score += q.points || 1;
    });

    quizEl.innerHTML = `
      <h2>R√©sultat du Quiz</h2>
      <p>Note obtenue : <strong>${score} / ${total}</strong></p>
    `;

    prevBtn.disabled = true;
    nextBtn.disabled = true;

    // ‚úÖ Afficher un toast de succ√®s
    showToast("Quiz termin√© avec succ√®s üéâ", "success");
  }

  prevBtn.addEventListener("click", () => {
    if (currentQuestionIndex > 0) {
      currentQuestionIndex--;
      displayQuestion(currentQuestionIndex);
    }
  });

  nextBtn.addEventListener("click", () => {
    const selected = document.querySelector('input[name="answer"]:checked');

    if (!selected) {
      // ‚ùå Toast erreur
      showToast("Veuillez s√©lectionner une r√©ponse.");
      return;
    }

    selectedAnswers[currentQuestionIndex] = parseInt(selected.value);

    if (currentQuestionIndex < questions.length - 1) {
      currentQuestionIndex++;
      displayQuestion(currentQuestionIndex);
    } else {
      afficherResultat();
    }
  });

  // R√©cup√©ration des questions depuis Django
  fetch(`/cours/quiz-data/${testId}/`)
    .then(res => res.json())
    .then(data => {
      if (!data.length) {
        quizEl.innerHTML = "<p>Pas de questions pour ce quiz.</p>";
        return;
      }
      questions = data;
      selectedAnswers = new Array(questions.length).fill(null);
      displayQuestion(currentQuestionIndex);
    })
    .catch(err => {
      console.error("Erreur r√©cup√©ration quiz:", err);
      quizEl.innerHTML = "<p>Impossible de charger le quiz.</p>";
    });
</script>

</body>
</html>
